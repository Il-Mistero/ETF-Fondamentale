<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fondamentale - ETF Valuation</title>
  <style>
  </style>
</head>
<body>
<div class="container">
  <header class="header">
    <h1 class="title">Fondamentale - ETF Edition</h1>
    <p class="subtitle">ETF Valuation Analysis with NAV Premium/Discount & Efficiency Metrics</p>
    <div class="status-bar">
      <div class="status-dot"></div>
      <span>Real-time ETF Data â€¢ Click refresh to update</span>
    </div>
  </header>

  <div class="metrics-summary" id="metricsSummary">
    <div class="metric-card"><div class="metric-value" id="totalETFs">-</div><div class="metric-label">Total ETFs</div></div>
    <div class="metric-card"><div class="metric-value" id="undervaluedCount">-</div><div class="metric-label">Undervalued</div></div>
    <div class="metric-card"><div class="metric-value" id="overvaluedCount">-</div><div class="metric-label">Overvalued</div></div>
    <div class="metric-card"><div class="metric-value" id="avgPremium">-</div><div class="metric-label">Avg Premium/Discount</div></div>
  </div>

  <div class="controls">
    <input type="text" class="search-box" placeholder="Search ETFs..." id="searchInput">
    <button class="refresh-btn" onclick="refreshData()">ðŸ”„ Refresh Data</button>
  </div>

  <div class="table-container">
    <table id="etfTable">
      <thead>
        <tr>
          <th onclick="sortTable(0)">ETF Name <span class="sort-arrow">â†•</span></th>
          <th onclick="sortTable(1)">Ticker <span class="sort-arrow">â†•</span></th>
          <th onclick="sortTable(2)">NAV <span class="sort-arrow">â†•</span></th>
          <th onclick="sortTable(3)">Price <span class="sort-arrow">â†•</span></th>
          <th onclick="sortTable(4)">Premium/Disc <span class="sort-arrow">â†•</span></th>
          <th onclick="sortTable(5)">Expense Ratio <span class="sort-arrow">â†•</span></th>
          <th onclick="sortTable(6)">P/E Ratio <span class="sort-arrow">â†•</span></th>
          <th onclick="sortTable(7)">Efficiency <span class="sort-arrow">â†•</span></th>
          <th onclick="sortTable(8)">Status <span class="sort-arrow">â†•</span></th>
          <th onclick="sortTable(9)">Score <span class="sort-arrow">â†•</span></th>
        </tr>
      </thead>
      <tbody id="etfTableBody">
        <tr><td colspan="10" class="loading"><div class="spinner"></div>Loading ETF data...</td></tr>
      </tbody>
    </table>
  </div>

  <footer class="footer">
    <p>ETF Valuation based on NAV Premium/Discount, Efficiency Metrics & Holdings Analysis</p>
    <p>Disclaimer: This is for educational purposes only. Not financial advice.</p>
  </footer>
</div>

<script>
// ====================== CONFIG ======================
const API_BASE_URL = "https://yh-finance.p.rapidapi.com/stock/v2/get-summary";
const API_KEY = "YOUR_RAPIDAPI_KEY"; // Replace with your key

const etfSymbols = ['VOO','IVV','SPY','VTI','QQQ','VUG','VEA','BND','AGG','IWF','GLD','IEMG','VGT','ARKK','TLT'];
const etfNames = {
  'VOO':'Vanguard S&P 500 ETF','IVV':'iShares Core S&P 500 ETF','SPY':'SPDR S&P 500 ETF Trust',
  'VTI':'Vanguard Total Stock Market ETF','QQQ':'Invesco QQQ Trust','VUG':'Vanguard Growth ETF',
  'VEA':'Vanguard FTSE Developed Markets ETF','BND':'Vanguard Total Bond Market ETF','AGG':'iShares U.S. Aggregate Bond ETF',
  'IWF':'iShares Russell 1000 Growth ETF','GLD':'SPDR Gold Shares','IEMG':'iShares Emerging Markets ETF',
  'VGT':'Vanguard Information Technology ETF','ARKK':'ARK Innovation ETF','TLT':'iShares 20+ Year Treasury Bond ETF'
};

let etfData = [];
let sortColumn = 9, sortDirection = -1;

// ====================== FETCH REAL DATA ======================
async function fetchRealETFData(symbol) {
  try {
    const url = `${API_BASE_URL}?symbol=${symbol}`;
    const response = await fetch(url, {
      method: "GET",
      headers: {
        "X-RapidAPI-Key": API_KEY,
        "X-RapidAPI-Host": "yh-finance.p.rapidapi.com"
      }
    });
    if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
    const json = await response.json();

    const quote = json.price || {};
    const summary = json.summaryDetail || {};
    const fundProfile = json.fundProfile || {};

    const price = quote.regularMarketPrice?.raw || 0;
    const nav = summary.navPrice?.raw || price; // fallback if missing
    const expenseRatio = summary.expenseRatio?.raw || fundProfile.annualReportExpenseRatio?.raw || 0.005;
    const peRatio = summary.trailingPE?.raw || 0;
    const volume = quote.regularMarketVolume?.raw || 0;
    const totalAssets = summary.totalAssets?.raw || 1e9;
    const dividendYield = summary.dividendYield?.raw || 0;
    const bidAskSpread = summary.bidAskSpread?.raw || 0.05;
    const trackingError = fundProfile.trackingError || 0.5;

    return calculateETFValuation({
      currentPrice: price, nav, expenseRatio, peRatio,
      volume, bidAskSpread, trackingError,
      totalAssets, dividendYield
    }, symbol);

  } catch (err) {
    console.error(`Fetch error for ${symbol}:`, err);
    return createErrorETF(symbol);
  }
}

// ====================== VALUATION ======================
function calculateETFValuation(data, symbol) {
  const { currentPrice, nav, expenseRatio, peRatio, volume, bidAskSpread, trackingError, totalAssets, dividendYield } = data;

  const navPremiumDiscount = ((currentPrice - nav) / nav) * 100;
  const efficiencyScore = calculateEfficiencyScore(expenseRatio, trackingError, bidAskSpread, volume, totalAssets);
  const valuationScore = calculateValuationScore(navPremiumDiscount, efficiencyScore, expenseRatio, peRatio, dividendYield);
  const status = determineETFStatus(navPremiumDiscount, valuationScore, efficiencyScore);

  return {
    name: etfNames[symbol] || symbol,
    ticker: symbol,
    nav, currentPrice,
    premiumDiscount: navPremiumDiscount,
    expenseRatio, peRatio,
    efficiencyScore, valuationScore,
    status
  };
}

function calculateEfficiencyScore(expenseRatio, trackingError, bidAskSpread, volume, totalAssets) {
  let expenseScore = Math.max(0, 100 - (expenseRatio * 20000));
  let trackingScore = Math.max(0, 100 - (trackingError * 40));
  let liquidityScore = Math.min(100, (volume / 1000000) * 20);
  let spreadScore = Math.max(0, 100 - (bidAskSpread * 200));
  let sizeScore = Math.min(100, Math.log10(totalAssets/1e6) * 20);
  return expenseScore*0.3 + trackingScore*0.25 + liquidityScore*0.2 + spreadScore*0.15 + sizeScore*0.1;
}

function calculateValuationScore(navPremiumDiscount, efficiencyScore, expenseRatio, peRatio, dividendYield) {
  let navScore = Math.max(0, Math.min(100, 50 - (navPremiumDiscount * 10)));
  let expenseScore = Math.max(0, 100 - (expenseRatio * 20000));
  let peScore = peRatio ? Math.max(0, 100 - ((peRatio - 15) * 2)) : 50;
  let dividendScore = Math.min(100, dividendYield * 200);
  return navScore*0.4 + efficiencyScore*0.3 + expenseScore*0.15 + peScore*0.1 + dividendScore*0.05;
}

function determineETFStatus(navPremiumDiscount, valuationScore, efficiencyScore) {
  if (valuationScore > 70 && navPremiumDiscount <= 0.5) return "Undervalued";
  if (valuationScore < 40 || navPremiumDiscount > 1.0) return "Overvalued";
  return "Fair Value";
}

function createErrorETF(symbol) {
  return { name: etfNames[symbol] || symbol, ticker: symbol, nav:0,currentPrice:0,premiumDiscount:0,expenseRatio:0,peRatio:0,efficiencyScore:0,valuationScore:0,status:"Data Error" };
}

// ====================== UI (unchanged from your code) ======================
// ... keep your renderTable, updateMetricsSummary, sortTable, filterTable, refreshData, init ...

// ====================== INIT ======================
async function fetchAllETFData() {
  const promises = etfSymbols.map(fetchRealETFData);
  return Promise.all(promises);
}
function refreshData() {
  document.getElementById('etfTableBody').innerHTML = '<tr><td colspan="10" class="loading"><div class="spinner"></div>Fetching real ETF data...</td></tr>';
  fetchAllETFData().then(data => { etfData = data; sortTable(sortColumn); }).catch(err => console.error(err));
}
function init() {
  refreshData();
  document.getElementById("searchInput").addEventListener("input", filterTable);
}
init();
</script>
</body>
</html>
