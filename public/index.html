<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fondamentale - ETF Valuation</title>
  <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        .title {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #a0a0c9;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        .status-bar {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 12px;
            padding: 12px 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 30px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4ade80;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-box {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 8px;
            padding: 10px 15px;
            color: white;
            width: 300px;
            font-size: 14px;
        }

        .search-box::placeholder {
            color: #a0a0c9;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
        }

        .table-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid rgba(102, 126, 234, 0.2);
            backdrop-filter: blur(10px);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3) 0%, rgba(118, 75, 162, 0.3) 100%);
        }

        th, td {
            padding: 15px 12px;
            text-align: left;
            border-bottom: 1px solid rgba(102, 126, 234, 0.1);
        }

        th {
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }

        th:hover {
            background: rgba(102, 126, 234, 0.2);
        }

        .sort-arrow {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.5;
            font-size: 12px;
        }

        tbody tr {
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .ticker {
            font-family: monospace;
            font-weight: 600;
            color: #667eea;
        }

        .price {
            font-weight: 600;
            font-family: monospace;
        }

        .status-undervalued {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-overvalued {
            background: rgba(248, 113, 113, 0.2);
            color: #f87171;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .percentage {
            font-weight: 600;
            font-family: monospace;
        }

        .percentage.positive {
            color: #4ade80;
        }

        .percentage.negative {
            color: #f87171;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #a0a0c9;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(102, 126, 234, 0.3);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            color: #a0a0c9;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .title {
                font-size: 2rem;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                width: 100%;
            }
            
            .table-container {
                overflow-x: auto;
            }
            
            th, td {
                padding: 10px 8px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
<div class="container">
  <header class="header">
    <h1 class="title">Fondamentale - ETF Edition</h1>
    <p class="subtitle">ETF Valuation Analysis with NAV Premium/Discount & Efficiency Metrics</p>
    <div class="status-bar">
      <div class="status-dot"></div>
      <span>Real-time ETF Data â€¢ Click refresh to update</span>
    </div>
  </header>

  <div class="metrics-summary" id="metricsSummary">
    <div class="metric-card"><div class="metric-value" id="totalETFs">-</div><div class="metric-label">Total ETFs</div></div>
    <div class="metric-card"><div class="metric-value" id="undervaluedCount">-</div><div class="metric-label">Undervalued</div></div>
    <div class="metric-card"><div class="metric-value" id="overvaluedCount">-</div><div class="metric-label">Overvalued</div></div>
    <div class="metric-card"><div class="metric-value" id="avgPremium">-</div><div class="metric-label">Avg Premium/Discount</div></div>
  </div>

  <div class="controls">
    <input type="text" class="search-box" placeholder="Search ETFs..." id="searchInput">
    <button class="refresh-btn" onclick="refreshData()">ðŸ”„ Refresh Data</button>
  </div>

  <div class="table-container">
    <table id="etfTable">
      <thead>
        <tr>
          <th onclick="sortTable(0)">ETF Name <span class="sort-arrow">â†•</span></th>
          <th onclick="sortTable(1)">Ticker <span class="sort-arrow">â†•</span></th>
          <th onclick="sortTable(2)">NAV <span class="sort-arrow">â†•</span></th>
          <th onclick="sortTable(3)">Price <span class="sort-arrow">â†•</span></th>
          <th onclick="sortTable(4)">Premium/Disc <span class="sort-arrow">â†•</span></th>
          <th onclick="sortTable(5)">Expense Ratio <span class="sort-arrow">â†•</span></th>
          <th onclick="sortTable(6)">P/E Ratio <span class="sort-arrow">â†•</span></th>
          <th onclick="sortTable(7)">Efficiency <span class="sort-arrow">â†•</span></th>
          <th onclick="sortTable(8)">Status <span class="sort-arrow">â†•</span></th>
          <th onclick="sortTable(9)">Score <span class="sort-arrow">â†•</span></th>
        </tr>
      </thead>
      <tbody id="etfTableBody">
        <tr><td colspan="10" class="loading"><div class="spinner"></div>Loading ETF data...</td></tr>
      </tbody>
    </table>
  </div>

  <footer class="footer">
    <p>ETF Valuation based on NAV Premium/Discount, Efficiency Metrics & Holdings Analysis</p>
    <p>Disclaimer: This is for educational purposes only. Not financial advice.</p>
  </footer>
</div>

<script>
// ====================== CONFIG ======================
const API_BASE_URL = "https://yh-finance.p.rapidapi.com/stock/v2/get-summary";
const API_KEY = "YOUR_RAPIDAPI_KEY"; // Replace with your key

const etfSymbols = ['VOO','IVV','SPY','VTI','QQQ','VUG','VEA','BND','AGG','IWF','GLD','IEMG','VGT','ARKK','TLT'];
const etfNames = {
  'VOO':'Vanguard S&P 500 ETF','IVV':'iShares Core S&P 500 ETF','SPY':'SPDR S&P 500 ETF Trust',
  'VTI':'Vanguard Total Stock Market ETF','QQQ':'Invesco QQQ Trust','VUG':'Vanguard Growth ETF',
  'VEA':'Vanguard FTSE Developed Markets ETF','BND':'Vanguard Total Bond Market ETF','AGG':'iShares U.S. Aggregate Bond ETF',
  'IWF':'iShares Russell 1000 Growth ETF','GLD':'SPDR Gold Shares','IEMG':'iShares Emerging Markets ETF',
  'VGT':'Vanguard Information Technology ETF','ARKK':'ARK Innovation ETF','TLT':'iShares 20+ Year Treasury Bond ETF'
};

let etfData = [];
let sortColumn = 9, sortDirection = -1;

// ====================== FETCH REAL DATA ======================
async function fetchRealETFData(symbol) {
  try {
    const url = `${API_BASE_URL}?symbol=${symbol}`;
    const response = await fetch(url, {
      method: "GET",
      headers: {
        "X-RapidAPI-Key": API_KEY,
        "X-RapidAPI-Host": "yh-finance.p.rapidapi.com"
      }
    });
    if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
    const json = await response.json();

    const quote = json.price || {};
    const summary = json.summaryDetail || {};
    const fundProfile = json.fundProfile || {};

    const price = quote.regularMarketPrice?.raw || 0;
    const nav = summary.navPrice?.raw || price; // fallback if missing
    const expenseRatio = summary.expenseRatio?.raw || fundProfile.annualReportExpenseRatio?.raw || 0.005;
    const peRatio = summary.trailingPE?.raw || 0;
    const volume = quote.regularMarketVolume?.raw || 0;
    const totalAssets = summary.totalAssets?.raw || 1e9;
    const dividendYield = summary.dividendYield?.raw || 0;
    const bidAskSpread = summary.bidAskSpread?.raw || 0.05;
    const trackingError = fundProfile.trackingError || 0.5;

    return calculateETFValuation({
      currentPrice: price, nav, expenseRatio, peRatio,
      volume, bidAskSpread, trackingError,
      totalAssets, dividendYield
    }, symbol);

  } catch (err) {
    console.error(`Fetch error for ${symbol}:`, err);
    return createErrorETF(symbol);
  }
}

// ====================== VALUATION ======================
function calculateETFValuation(data, symbol) {
  const { currentPrice, nav, expenseRatio, peRatio, volume, bidAskSpread, trackingError, totalAssets, dividendYield } = data;

  const navPremiumDiscount = ((currentPrice - nav) / nav) * 100;
  const efficiencyScore = calculateEfficiencyScore(expenseRatio, trackingError, bidAskSpread, volume, totalAssets);
  const valuationScore = calculateValuationScore(navPremiumDiscount, efficiencyScore, expenseRatio, peRatio, dividendYield);
  const status = determineETFStatus(navPremiumDiscount, valuationScore, efficiencyScore);

  return {
    name: etfNames[symbol] || symbol,
    ticker: symbol,
    nav, currentPrice,
    premiumDiscount: navPremiumDiscount,
    expenseRatio, peRatio,
    efficiencyScore, valuationScore,
    status
  };
}

function calculateEfficiencyScore(expenseRatio, trackingError, bidAskSpread, volume, totalAssets) {
  let expenseScore = Math.max(0, 100 - (expenseRatio * 20000));
  let trackingScore = Math.max(0, 100 - (trackingError * 40));
  let liquidityScore = Math.min(100, (volume / 1000000) * 20);
  let spreadScore = Math.max(0, 100 - (bidAskSpread * 200));
  let sizeScore = Math.min(100, Math.log10(totalAssets/1e6) * 20);
  return expenseScore*0.3 + trackingScore*0.25 + liquidityScore*0.2 + spreadScore*0.15 + sizeScore*0.1;
}

function calculateValuationScore(navPremiumDiscount, efficiencyScore, expenseRatio, peRatio, dividendYield) {
  let navScore = Math.max(0, Math.min(100, 50 - (navPremiumDiscount * 10)));
  let expenseScore = Math.max(0, 100 - (expenseRatio * 20000));
  let peScore = peRatio ? Math.max(0, 100 - ((peRatio - 15) * 2)) : 50;
  let dividendScore = Math.min(100, dividendYield * 200);
  return navScore*0.4 + efficiencyScore*0.3 + expenseScore*0.15 + peScore*0.1 + dividendScore*0.05;
}

function determineETFStatus(navPremiumDiscount, valuationScore, efficiencyScore) {
  if (valuationScore > 70 && navPremiumDiscount <= 0.5) return "Undervalued";
  if (valuationScore < 40 || navPremiumDiscount > 1.0) return "Overvalued";
  return "Fair Value";
}

function createErrorETF(symbol) {
  return { name: etfNames[symbol] || symbol, ticker: symbol, nav:0,currentPrice:0,premiumDiscount:0,expenseRatio:0,peRatio:0,efficiencyScore:0,valuationScore:0,status:"Data Error" };
}

// ====================== UI (unchanged from your code) ======================
// ... keep your renderTable, updateMetricsSummary, sortTable, filterTable, refreshData, init ...

// ====================== INIT ======================
async function fetchAllETFData() {
  const promises = etfSymbols.map(fetchRealETFData);
  return Promise.all(promises);
}
function refreshData() {
  document.getElementById('etfTableBody').innerHTML = '<tr><td colspan="10" class="loading"><div class="spinner"></div>Fetching real ETF data...</td></tr>';
  fetchAllETFData().then(data => { etfData = data; sortTable(sortColumn); }).catch(err => console.error(err));
}
function init() {
  refreshData();
  document.getElementById("searchInput").addEventListener("input", filterTable);
}
init();
</script>
</body>
</html>
